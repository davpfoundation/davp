name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

env:
  TAG: ${{ github.ref_name }}
  BINARIES: davp davp_bootstrap_server

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Build (release)
        run: |
          cargo build --release -p davp --bin davp
          cargo build --release -p davp_bootstrap_server --bin davp_bootstrap_server

      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $pkg = "davp-$env:TAG-windows-x86_64"
          New-Item -ItemType Directory -Force -Path $pkg | Out-Null
          foreach ($bin in @("davp","davp_bootstrap_server")) {
            Copy-Item -Force "target\release\$bin.exe" "$pkg\"
          }
          Compress-Archive -Force -Path "$pkg\*" -DestinationPath "$pkg.zip"

      - name: Upload artifact (Windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: davp-${{ env.TAG }}-windows-x86_64.zip

      - name: Package (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          
          pkg="davp-${TAG}-linux-x86_64"
          mkdir -p "$pkg"
          for bin in $BINARIES; do
            cp -f "target/release/$bin" "$pkg/"
          done
          tar -czf "$pkg.tar.gz" "$pkg"

          # AppImage
          APPDIR="Davp.AppDir"
          rm -rf "$APPDIR"
          mkdir -p "$APPDIR/usr/bin"
          cp -f target/release/davp "$APPDIR/usr/bin/"

          cat <<'EOF' | sed 's/^          //' > "$APPDIR/davp.desktop"
          [Desktop Entry]
          Type=Application
          Name=DAVP
          Exec=davp
          Icon=davp
          Categories=Utility;
          Terminal=true
          EOF

          cat <<'EOF' | sed 's/^          //' > "$APPDIR/davp.svg"
          <svg xmlns="http://www.w3.org/2000/svg" width="256" height="256" viewBox="0 0 256 256">
            <rect width="256" height="256" rx="48" fill="#111827"/>
            <text x="50%" y="54%" dominant-baseline="middle" text-anchor="middle" font-size="72" font-family="Arial, sans-serif" fill="#ffffff">DAVP</text>
          </svg>
          EOF

          cat <<'EOF' | sed 's/^          //' > "$APPDIR/AppRun"
          #!/bin/sh
          HERE="$(dirname "$(readlink -f "$0")")"
          exec "${HERE}/usr/bin/davp" "$@"
          EOF
          chmod +x "$APPDIR/AppRun"

          curl -L -o appimagetool "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage"
          chmod +x appimagetool
          ./appimagetool "$APPDIR" "davp-${TAG}-linux-x86_64.AppImage"

      - name: Upload artifacts (Linux)
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts
          path: |
            davp-${{ env.TAG }}-linux-x86_64.tar.gz
            davp-${{ env.TAG }}-linux-x86_64.AppImage
